# VSYNC

VSYNC（Vertical Synchronization垂直同步）

Refresh Rate：代表了屏幕在一秒内刷新屏幕的次数，这取决于硬件的固定参数，例如60HZ
Frame Rate；代表了GPU在一秒内绘制操作的帧数，例如30fps，60fps

GPU会获取图形数据进行渲染，然后硬件负责把渲染后的内容呈现到屏幕上，他们两者不停的进行协作
但刷新频率和帧率并不是总能够保持相同的节奏。如果发生帧率与刷新频率不一致的情况，就会容易出现不同的两帧数据发生重叠
通常来说，帧率超过刷新频率只是一种理想的状况，在超过60fps的情况下，GPU所产生的帧数据会因为等待VSYNC的刷新信息而被Hold住，遇到更多的情况是帧率小于刷新频率。

## 疑问
1. 丢帧（掉帧），是说这一帧延迟显示还是丢弃不再显示？
2. 布局层次较多/主线程耗时是如何造成丢帧的呢？
3. 16.6ms刷新一次是啥意思？是每16.6ms都走一次measure/layout/draw?
4. measure/layout/draw走完，界面就立刻刷新了吗 ？
5. 如果界面没动静了，还会刷新吗？
6. VSYNC，这个具体指啥？在屏幕刷新中如何工作的？
7. 可能你还听过屏幕刷新使用双缓存、三缓存，这又是啥意思呢？
8. 可能你还听过神秘的Choreographer，这又是啥？

# 显示系统知识
一般包括CPU、GPU、Display三个部分，CPU负责计算帧率，把计算好的数据交给GPU，GPU会对图像进行渲染，渲染好后放到buffer（图像缓冲区）里存起来，然后Display（屏幕或显示器）负责把buffer里的数据呈现到屏幕上。

## Render Performance

Android系统每隔16ms发出VSYNC信号，触发对UI进行渲染，如果每次渲染都成功，这样就能够达到流畅的画面所需要的60fps，为了能够实现60fps，这意味着程序的大多数操作都必须在16ms内完成。

![draw_per_16ms](/img/draw_per_16ms.png)

如果你的某个操作花费时间是24ms，系统在得到VSYNC信号的时候就无法进行正常渲染，这样就发生了丢帧现象。那么用户在32ms内看到的会是同一帧画面。

![vsync_over_draw](/img/vsync_over_draw.png)
# 总结
- 同步是防止画面撕裂的关键，VSYNC同步能防止画面撕裂
- VSYNC双缓冲在Android中能有序规划渲染流程，降低延时
- Android已经采用了双缓冲，双缓冲不仅仅是两份存储，它是一个概念，双缓冲是一条链路，不是某一个环节，是整个系统采用的一个机智，需要各个环节的支持，从APP到SurfaceFlinger、到图像显示都要参与协作
- 三缓冲在UI复杂情况下能保证画面的连续性，提高柔韧性